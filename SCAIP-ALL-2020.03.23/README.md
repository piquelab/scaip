After align reads and deconvolute individuals, we will do the following analysis, including transforming data into seurat object, correcting chemistry noise and clustering analysis and cell type annotation. Once annotate cell type to our single cell data, we will do the differential gene expression analysis for each cell type separately, calculate gene variability and do the differential gene variability analysis. We also calculate linear discriminant analysis (LDA) to distinguish dynamical changes of gene expression along various immune treatments.

####   
1. Read demux output, 1_demux2.R
2. Merge align reads from `/nfs/rprdata/julong/SCAIP/kallisto2/bus/, 2_merge_kb2.R
3. compare data of SCAIP1-5 and SCAIP1-6, 3_compareNewAndOld.R
####
4. Normalization data, correct batch effects and cluster analysis , 4_Harmony.R
5. Cell type annotation, 5_IdenCelltype_seurat.R

#### Differential expression analysis
The R script is 6_DEG.CelltypeNew.R 
First we generated pseducounts by summing reads of cells from the same conbination(cell type+treatment+individual).
Input data ./5_IdenCelltype_output/4_SCAIP.MCls.Harmony.rds
The directory ./6_DEG.CelltypeNew_output/Filter2/ is the output of filtering conditions, protein genes from autosomes with larger than 20 reads across cells and combination with larger than 20 cells.
- YtX.comb.RData, a matrix of 42,554(genes)*1,536(combinations), including all the autosome genes(>0 reads across cells) and all the combinations. The rowname is "ENSEMBLE.suffix"
- 0_ncell.RData summarize number of cells of each combination. It is a data frame, 1536*2
- YtX_sel.comb.RData, a matrix of 15,770(genes)*1,419(combinations), the final data used for differential anlysis and QTL mapping. It is a subset of YtX generated by by applying the following filtering conditions, protein coding genes, genes with larger than 20 reads, combinations with larger than 20 cells.  

#### Gene ontology (GO) enrichment analysis for DEG
The R script is 7_GSE.ClusterProfiler.R
The ./Filter2/ are the output of enrichment results of DEG under Filter2 threshold.
We need two input data,./6_DEG.CelltypeNew_output/Filter2/YtX_sel.comb.RData for background genes and ./6_DEG.CelltypeNew_output/Filter2/2_meta.rds to provide DEGs.
The outputs are included,
./7_GSE.ClusterProfiler_output/Filter2/1_enrichGO.rds is GO enrichment results;
./7_GSE.ClusterProfiler_output/Filter2/2_enrichKEGG.rds is KEGG enrichment results.
   
#### Calculating linear discriminant analysis (LDA)
The R script is 9_RNA.dynamic2.R.
./Filter2_DEG6571/ is the output of LDA from differentially expressed genes under Filter2 threshold. 
We need two input data, ./5_IdenCelltype_output/4_SCAIP.MCls.Harmony.rds and ./6_DEG.CelltypeNew_output/Filter2/Sigs.gene.DEG.RData.
First we generated the subset of seurat object by extracting differentially expressed genes(DEGs) and removing batch 2 and 3. ./9_RNA.dynamic2_output/Filter2_DEG6571/2_Batch1456.DEG.rds.
Then we normalized data and corrected chemistry noise by for each cell type separately.  The outputs are in ./9_RNA.dynamic2_output/Filter2_DEG6571/Old/3_MCl.*.old.rds
The LDA results are in the ./9_RNA.dynamic2_output/Filter2_DEG6571/Old/4.1_LDA.*.meta.rds. Meanwhile we reverse LDA_2 for B cell, Monocyte and T cell in LDA_2rev column. 
The average gene expression of bins based on LDA_1 for each treatment are in the ./9_RNA.dynamic2_output/Filter2_DEG6571/Old/LDA1Bin/YtX.*.ave.RData.
The average gene expression of bins based on LDA_2 for each treatment are in the ./9_RNA.dynamic2_output/Filter2_DEG6571/Old/LDA2Bin/YtX.*.ave.RData.
For averaging gene expression, we just include the 15,770 protein coding genes from autosomes with larger than 20 reads across cells, the same filtering threshold to previous data analysis.  

#### Calculating gene variability parameters and differential analysis
The R script is 10_RNA.variance.R.
The ./tmp9/ is the output of the normalized counts divided by median reads depth across cells  and  the application of the following filtering threshold,
(1). autosomes genes with larger than 20 reads across cells; 
(2). combinations (cell type+treatment+individual) with larger than 20 cells; 
(3). When calculating gene variance, keep genes with 15 reads and 15 expressed cells for each combination;
(4). Protein coding genes for differential analysis
(5). In the differential analysis, at least 3 individuals in the treatment and 3 individuals in control condition that is being. 
The following data are a matrix of 30,972(genes)*1,419(combination) from the filtering threshold (1), (2) and (3). 
- 1_RNA.Bx.RData for mean parameters
- 1_RNA.Phx.RData for dispersion parameters
- 1_RNA.PhxNew.RData for residual dispersion parameters
- 1_RNA.Vx.RData for variance parameters
Then we extract protein coding genes, a matrix of 15,770*1419;
- 1.2_Sel.Bx.RData
- 1.2_Sel.Phx.RData
- 1.2_Sel.PhxNew.RData
-1.2_Sel.Vx.RData
  
#10. GO enrichment analysis for differential variable genes(DVG), 10_GSE.ClusterProfiler.R
#11. Example genes, 11_GENE.example.R
## 